#!/bin/bash

cd ~

# Basically: which device file corresponds to my external hard drive?
# C4383821A0A1 is the serial number of my ADATA external hard drive
drive_device="$(lsblk -do +SERIAL | awk '$7=="C4383821A0A1" {print $1}')"

if [[ $drive_device = "" ]]
then
    echo -e "External hard drive not connected. \e[1;33mAborting\e[0m"
else
    echo "External hard drive connected at device $drive_device"
    sudo mount /dev/$drive_device /mnt

    read -p "Do you want to perform a dry run? [Y/y] " -n 1 -r
    echo
    echo $REPLY
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
	echo "Performing dry run"
	sudo rsync -avhn --exclude-from='dotfiles/backup-filters' . /mnt/niyx/
    else
	echo "Performing true sync"
	sudo rsync -avh --exclude-from='dotfiles/backup-filters' . /mnt/niyx/
    fi
    
    # Cleaning up...
    # This allows us to run the script multiple times (without it, the drive is still mounted and thus will
    # appear to not be connected when we try again)
    sudo umount /mnt
fi
